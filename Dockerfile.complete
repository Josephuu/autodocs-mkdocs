# =============================================================================
# Dockerfile.complete - Sistema Completo de DocumentaciÃ³n Automatizada
# VersiÃ³n: 2.1 - Corregida y Optimizada
# =============================================================================
FROM ubuntu:22.04

LABEL maintainer="DevOps Team"
LABEL description="Complete documentation automation system with diagram generation"
LABEL version="2.1"

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PYTHONUNBUFFERED=1 \
    WORKSPACE=/workspace \
    NODE_VERSION=20 \
    HELM_VERSION=3.13.3 \
    TERRAFORM_VERSION=1.7.0

# =============================================================================
# InstalaciÃ³n de Dependencias Base
# =============================================================================
RUN apt-get update && apt-get install -y \
    build-essential pkg-config \
    curl wget git vim nano tree jq unzip tar gzip \
    ca-certificates gnupg lsb-release software-properties-common apt-transport-https \
    python3 python3-pip python3-dev python3-venv \
    graphviz graphviz-dev \
    fonts-liberation fonts-dejavu-core \
    docker.io \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Node.js 20.x LTS
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && \
    apt-get install -y nodejs && npm install -g npm@latest

# Terraform
RUN wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
    unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
    mv terraform /usr/local/bin/ && rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip

# Helm CLI
RUN curl -fsSL https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz -o helm.tar.gz && \
    tar -xzf helm.tar.gz && mv linux-amd64/helm /usr/local/bin/helm && \
    rm -rf linux-amd64 helm.tar.gz

# kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && \
    chmod +x kubectl && mv kubectl /usr/local/bin/

# Python Tools
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel && \
    pip3 install --no-cache-dir \
    pre-commit==3.6.0 docsible==0.8.0 \
    mkdocs==1.5.3 mkdocs-material==9.5.3 mkdocs-mermaid2-plugin==1.1.1 \
    pymdown-extensions==10.7 mkdocs-git-revision-date-localized-plugin==1.2.2 \
    mkdocs-minify-plugin==0.8.0 pyyaml==6.0.1 ansible-core==2.15.8 \
    diagrams==0.23.4 graphviz==0.20.1

# terraform-docs
RUN TERRAFORM_DOCS_VERSION="v0.17.0" && \
    curl -Lo /tmp/terraform-docs.tar.gz \
        "https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-linux-amd64.tar.gz" && \
    tar -xzf /tmp/terraform-docs.tar.gz -C /tmp && \
    mv /tmp/terraform-docs /usr/local/bin/ && rm /tmp/terraform-docs.tar.gz

# helm-docs
RUN HELM_DOCS_VERSION="1.13.1" && \
    curl -Lo /tmp/helm-docs.tar.gz \
        "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" && \
    tar -xzf /tmp/helm-docs.tar.gz -C /tmp && \
    mv /tmp/helm-docs /usr/local/bin/ && rm /tmp/helm-docs.tar.gz

# hadolint
RUN HADOLINT_VERSION="v2.12.0" && \
    wget -q -O /usr/local/bin/hadolint \
        "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" && \
    chmod +x /usr/local/bin/hadolint

# kubeval
RUN KUBEVAL_VERSION="v0.16.1" && \
    curl -Lo /tmp/kubeval.tar.gz \
        "https://github.com/instrumenta/kubeval/releases/download/${KUBEVAL_VERSION}/kubeval-linux-amd64.tar.gz" && \
    tar -xzf /tmp/kubeval.tar.gz -C /tmp && \
    mv /tmp/kubeval /usr/local/bin/ && rm /tmp/kubeval.tar.gz

# InfraMap
RUN INFRAMAP_VERSION="v0.6.7" && \
    curl -Lo /usr/local/bin/inframap \
        "https://github.com/cycloidio/inframap/releases/download/${INFRAMAP_VERSION}/inframap-linux-amd64" && \
    chmod +x /usr/local/bin/inframap

# Terravision (via npm)
RUN npm install -g @terravision/cli || echo "âš ï¸  Terravision opcional"

# =============================================================================
# Scripts del Sistema
# =============================================================================

# Usuario no-root
RUN useradd -m -s /bin/bash -u 1000 devops && \
    echo "devops ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Crear directorios ANTES de cambiar usuario
RUN mkdir -p /home/devops/.local/scripts /home/devops/.local/bin /workspace

# Script: generate-mkdocs-index.sh (CRÃTICO - Genera Ã­ndices para MkDocs)
COPY <<'EOFSCRIPT' /home/devops/.local/scripts/generate-mkdocs-index.sh
#!/bin/bash
# =============================================================================
# Genera automÃ¡ticamente los archivos index.md para MkDocs
# Uso: WORKSPACE=/ruta/al/repo ./generate-mkdocs-index.sh
# =============================================================================

set -e

WS="${WORKSPACE:-/workspace}"
DOCS_DIR="${WS}/docs"

echo "ğŸ“‘ Generando index.md para MkDocs..."
echo "   WORKSPACE: ${WS}"
echo "   DOCS_DIR: ${DOCS_DIR}"

mkdir -p "${DOCS_DIR}"

generate_terraform_index() {
    local OUTPUT="${DOCS_DIR}/terraform/index.md"
    mkdir -p "$(dirname "$OUTPUT")"
    
    echo "# Terraform" > "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "MÃ³dulos de infraestructura como cÃ³digo para Azure." >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "## MÃ³dulos Disponibles" >> "$OUTPUT"
    echo "" >> "$OUTPUT"

    local MODULES_DIR="${DOCS_DIR}/terraform/modules"
    if [ -d "$MODULES_DIR" ]; then
        local found=false
        for md_file in "$MODULES_DIR"/*.md; do
            [ -f "$md_file" ] || continue
            local module_name=$(basename "$md_file" .md)
            echo "- [${module_name}](./modules/${module_name}.md)" >> "$OUTPUT"
            found=true
        done
        [ "$found" = false ] && echo "- No hay mÃ³dulos documentados" >> "$OUTPUT"
    else
        echo "- No hay mÃ³dulos documentados" >> "$OUTPUT"
    fi
    echo "" >> "$OUTPUT"
    echo "## Uso RÃ¡pido" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo '\`\`\`hcl' >> "$OUTPUT"
    echo 'module "ejemplo" {' >> "$OUTPUT"
    echo '  source = "./modules/<nombre-modulo>"' >> "$OUTPUT"
    echo '}' >> "$OUTPUT"
    echo '\`\`\`' >> "$OUTPUT"
    echo "  âœ“ ${OUTPUT}"
}

generate_ansible_index() {
    local OUTPUT="${DOCS_DIR}/ansible/index.md"
    mkdir -p "$(dirname "$OUTPUT")"
    
    echo "# Ansible" > "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "Roles para configuraciÃ³n de servidores." >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "## Roles Disponibles" >> "$OUTPUT"
    echo "" >> "$OUTPUT"

    local ROLES_DIR="${DOCS_DIR}/ansible/roles"
    if [ -d "$ROLES_DIR" ]; then
        local found=false
        for md_file in "$ROLES_DIR"/*.md; do
            [ -f "$md_file" ] || continue
            local role_name=$(basename "$md_file" .md)
            echo "- [${role_name}](./roles/${role_name}.md)" >> "$OUTPUT"
            found=true
        done
        [ "$found" = false ] && echo "- No hay roles documentados" >> "$OUTPUT"
    else
        echo "- No hay roles documentados" >> "$OUTPUT"
    fi
    echo "  âœ“ ${OUTPUT}"
}

generate_kubernetes_index() {
    local OUTPUT="${DOCS_DIR}/kubernetes/index.md"
    mkdir -p "$(dirname "$OUTPUT")"
    
    echo "# Kubernetes" > "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "Helm Charts para AKS." >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "## Charts Disponibles" >> "$OUTPUT"
    echo "" >> "$OUTPUT"

    local CHARTS_DIR="${DOCS_DIR}/kubernetes/helm"
    if [ -d "$CHARTS_DIR" ]; then
        local found=false
        for md_file in "$CHARTS_DIR"/*.md; do
            [ -f "$md_file" ] || continue
            local chart_name=$(basename "$md_file" .md)
            echo "- [${chart_name}](./helm/${chart_name}.md)" >> "$OUTPUT"
            found=true
        done
        [ "$found" = false ] && echo "- No hay charts documentados" >> "$OUTPUT"
    else
        echo "- No hay charts documentados" >> "$OUTPUT"
    fi
    echo "  âœ“ ${OUTPUT}"
}

generate_docker_index() {
    local OUTPUT="${DOCS_DIR}/docker/index.md"
    mkdir -p "$(dirname "$OUTPUT")"
    
    echo "# Docker" > "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "Aplicaciones containerizadas." >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "## Aplicaciones" >> "$OUTPUT"
    echo "" >> "$OUTPUT"

    local APPS_DIR="${DOCS_DIR}/docker/apps"
    if [ -d "$APPS_DIR" ]; then
        local found=false
        for md_file in "$APPS_DIR"/*.md; do
            [ -f "$md_file" ] || continue
            local app_name=$(basename "$md_file" .md)
            echo "- [${app_name}](./apps/${app_name}.md)" >> "$OUTPUT"
            found=true
        done
        [ "$found" = false ] && echo "- No hay apps documentadas" >> "$OUTPUT"
    else
        echo "- No hay apps documentadas" >> "$OUTPUT"
    fi
    echo "  âœ“ ${OUTPUT}"
}

generate_runbooks_index() {
    local OUTPUT="${DOCS_DIR}/runbooks/index.md"
    mkdir -p "$(dirname "$OUTPUT")"
    
    echo "# Runbooks" > "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "Procedimientos operacionales." >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo "## Backup" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    echo '\`\`\`bash' >> "$OUTPUT"
    echo 'pg_dump db > backup.sql' >> "$OUTPUT"
    echo '\`\`\`' >> "$OUTPUT"
    echo "  âœ“ ${OUTPUT}"
}

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Generando Ã­ndices para MkDocs"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
generate_terraform_index
generate_ansible_index
generate_kubernetes_index
generate_docker_index
generate_runbooks_index
echo ""
echo "âœ… Ãndices generados correctamente"
EOFSCRIPT

# Script: generate-all-diagrams.sh
COPY <<'EOFSCRIPT' /home/devops/.local/scripts/generate-all-diagrams.sh
#!/bin/bash
set -e
echo "ğŸ¨ Generando TODOS los diagramas..."
mkdir -p ${WORKSPACE}/docs/diagrams/{terraform,ansible,kubernetes,docker}

if [ -d "${WORKSPACE}/terraform" ]; then
    echo "ğŸ“¦ Terraform..."
    command -v inframap &> /dev/null && \
        inframap generate ${WORKSPACE}/terraform/ 2>/dev/null | \
        dot -Tsvg > ${WORKSPACE}/docs/diagrams/terraform/dependencies.svg || true
fi

echo "âœ… Diagramas generados"
EOFSCRIPT

# Script: init-workspace.sh
COPY <<'EOFSCRIPT' /home/devops/.local/bin/init-workspace.sh
#!/bin/bash
set -e
WS=${WORKSPACE:-/workspace}
echo "ğŸš€ Inicializando workspace: $WS"
cd "$WS" || exit 1
mkdir -p docs/diagrams/{terraform,ansible,kubernetes,docker} docs/{architecture,runbooks}

# Crear .hadolint.yaml si no existe
if [ ! -f .hadolint.yaml ]; then
cat > .hadolint.yaml << 'EOFHADOLINT'
ignored:
  - DL3008
  - DL3013
  - DL3015
  - DL3016
  - DL3018
  - DL4001
  - DL4006
trustedRegistries:
  - docker.io
  - gcr.io
EOFHADOLINT
    echo "âœ… .hadolint.yaml creado"
fi

# Crear generate-mkdocs-index.sh en el workspace si no existe
if [ ! -f generate-mkdocs-index.sh ]; then
    cp /home/devops/.local/scripts/generate-mkdocs-index.sh ./generate-mkdocs-index.sh
    chmod +x generate-mkdocs-index.sh
    echo "âœ… generate-mkdocs-index.sh copiado al workspace"
fi

echo "âœ… Workspace listo!"
EOFSCRIPT

# Template pre-commit mejorado
COPY <<'EOFPC' /home/devops/.pre-commit-config-template.yaml
repos:
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.88.0
    hooks:
      - id: terraform_fmt
      - id: terraform_validate
      - id: terraform_docs
        args: 
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true
  
  - repo: local
    hooks:
      - id: generate-mkdocs-index
        name: Generate MkDocs Index Files
        entry: bash generate-mkdocs-index.sh
        language: system
        pass_filenames: false
        always_run: true
EOFPC

# Cambiar permisos y ownership
RUN chmod +x /home/devops/.local/scripts/*.sh /home/devops/.local/bin/*.sh && \
    chown -R devops:devops /home/devops/.local /workspace

# Usuario devops
USER devops
WORKDIR /home/devops

ENV PATH="/home/devops/.local/bin:/home/devops/.local/scripts:${PATH}"

HEALTHCHECK --interval=30s --timeout=3s CMD terraform-docs --version && helm version && echo "âœ… OK"

EXPOSE 8000

# Mensaje bienvenida
RUN echo 'echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"' >> /home/devops/.bashrc && \
    echo 'echo "  Docs Automation v2.1 - Ready!"' >> /home/devops/.bashrc && \
    echo 'echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"' >> /home/devops/.bashrc && \
    echo 'echo "ğŸ”§ init-workspace.sh - Inicializar"' >> /home/devops/.bashrc && \
    echo 'echo "ğŸ“ generate-mkdocs-index.sh - Generar Ã­ndices"' >> /home/devops/.bashrc && \
    echo 'echo "ğŸ¨ generate-all-diagrams.sh - Diagramas"' >> /home/devops/.bashrc && \
    echo 'echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"' >> /home/devops/.bashrc

WORKDIR ${WORKSPACE}
CMD ["/bin/bash"]
